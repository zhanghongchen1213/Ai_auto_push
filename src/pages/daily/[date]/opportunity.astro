---
import { getCollection } from 'astro:content';
import { render } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { formatDateCN } from '../../../lib/date-utils';
import { compareDates } from '../../../lib/date-utils';
import { parseOpportunityMarkdown, renderMd } from '../../../lib/opportunity-utils';
import { siteConfig } from '../../../config/site';

export async function getStaticPaths() {
	const allEntries = await getCollection('daily', (e) => e.data.domain === 'commercial-opportunity');
	return allEntries.map((entry) => ({
		params: { date: entry.data.date },
		props: { entry },
	}));
}

const { entry } = Astro.props;
const { data, body } = entry;
const date = data.date;
const dateCN = formatDateCN(date);
const opp = parseOpportunityMarkdown(body ?? '');
const isCommercializable = (data as any).finalStatus === 'commercializable';
const proposalName = (data as any).proposalName || '';
const proposalScore = (data as any).proposalScore || '';
const backUrl = `/Ai_auto_push/daily/${date}`;
---

<BaseLayout title={`商业机会详情 · ${dateCN}`} description="商业机会日报详情">
	<div class="detail-wrap">
		<a href={backUrl} class="back-row">← 返回当日简报</a>
		<h1 class="detail-title">商业机会详情 · {dateCN}</h1>
		{proposalName && (
			<p class="detail-subtitle">方案名称：{proposalName}。该方案由系统在多源检索与双阶段筛选后自动确认。</p>
		)}
		{!proposalName && (
			<p class="detail-subtitle">今日未发现可商业化方案。以下为完整检索与筛选记录。</p>
		)}

		<div class="metrics-row">
			<div class="metric-card">
				<div class="metric-label">综合评分</div>
				<div class="metric-value">{proposalScore ? `${proposalScore} / 10` : '—'}</div>
			</div>
			<div class="metric-card">
				<div class="metric-label">检索候选</div>
				<div class="metric-value">{(data as any).retrievedCount ?? 0} 条</div>
			</div>
			<div class="metric-card">
				<div class="metric-label">最终结论</div>
				<div class={`metric-value ${isCommercializable ? 'text-green' : ''}`}>
					{isCommercializable ? '可商业化，进入验证' : '今日无可用方案'}
				</div>
			</div>
		</div>

		{opp.searchDomains && (
			<section class="detail-section section-domains">
				<h2>今日检索领域</h2>
				<div class="section-body" set:html={renderMd(opp.searchDomains)} />
			</section>
		)}

		{opp.exploredItems.length > 0 && (
			<section class="detail-section">
				<h2>尝试探索内容（{opp.exploredItems.length}）</h2>
				{opp.exploredItems.map(item => <div set:html={renderMd(item)} />)}
			</section>
		)}

		{opp.discardedItems.length > 0 && (
			<section class="detail-section">
				<h2>无价值方案及淘汰理由（{opp.discardedItems.length}）</h2>
				{opp.discardedItems.map(d => <p><strong>{d.title}</strong>：{d.reason}</p>)}
			</section>
		)}

		<section class={`detail-section ${isCommercializable ? 'section-final' : ''}`}>
			<h2>{isCommercializable ? '最终确认的可商业化方案' : '最终方案'}</h2>
			{isCommercializable && proposalName && <div class="final-name">{proposalName}</div>}
			<div class="section-body" set:html={renderMd(opp.finalSection)} />
		</section>

		{opp.evidenceSection && (
			<section class="detail-section">
				<h2>证据链</h2>
				<div class="section-body" set:html={renderMd(opp.evidenceSection)} />
			</section>
		)}

		{opp.validationPlan && (
			<section class="detail-section section-plan">
				<h2>验证计划</h2>
				<div class="section-body" set:html={renderMd(opp.validationPlan)} />
			</section>
		)}

		<div class="detail-nav">
			<a href={backUrl}>返回当日首页 →</a>
		</div>
	</div>
</BaseLayout>

<style>
	.detail-wrap { max-width: 900px; margin: 0 auto; padding: 20px 48px; }
	.back-row { font-size: 13px; font-weight: 500; color: #2563EB; text-decoration: none; display: inline-block; margin-bottom: 12px; }
	.detail-title { font-size: 24px; font-weight: 700; color: #1A1A1A; margin: 0 0 8px; }
	.detail-subtitle { font-size: 14px; color: #6B7280; line-height: 1.6; margin: 0 0 16px; }
	.metrics-row { display: flex; gap: 12px; margin-bottom: 16px; }
	.metric-card { flex: 1; background: #F9FAFB; border-radius: 8px; padding: 12px; }
	.metric-label { font-size: 12px; font-weight: 500; color: #6B7280; margin-bottom: 4px; }
	.metric-value { font-size: 18px; font-weight: 700; color: #1A1A1A; }
	.text-green { color: #166534; }
	.detail-section { background: #F9FAFB; border-radius: 8px; padding: 16px; margin-bottom: 12px; }
	.detail-section h2 { font-size: 14px; font-weight: 600; color: #1A1A1A; margin: 0 0 8px; }
	.detail-section p { font-size: 13px; color: #6B7280; line-height: 1.6; margin: 4px 0; }
	.section-body { font-size: 13px; color: #6B7280; line-height: 1.6; }
	.section-body :global(h3) { font-size: 14px; font-weight: 600; color: #1A1A1A; margin: 12px 0 6px; }
	.section-body :global(ul) { margin: 4px 0; padding-left: 20px; }
	.section-body :global(li) { margin: 2px 0; }
	.section-body :global(a) { color: #2563EB; text-decoration: none; }
	.section-body :global(strong) { color: #374151; }
	.section-domains { background: #FFFBEB; }
	.section-domains h2 { color: #92400E; }
	.section-final { background: #ECFDF5; }
	.section-final h2 { color: #166534; }
	.section-plan { background: #FFF7E6; }
	.section-plan h2 { color: #D46B08; }
	.final-name { font-size: 20px; font-weight: 700; color: #1A1A1A; margin-bottom: 8px; }
	.detail-nav { margin-top: 16px; }
	.detail-nav a { font-size: 13px; font-weight: 500; color: #2563EB; text-decoration: none; margin-right: 16px; }
	@media (max-width: 767px) {
		.detail-wrap { padding: 16px; }
		.metrics-row { flex-direction: column; }
		.detail-title { font-size: 20px; }
	}
</style>
