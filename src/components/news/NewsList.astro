---
import type { CollectionEntry } from 'astro:content';
import { domains } from '../../config/domains';
import type { DomainConfig } from '../../config/domains';
import { parseNewsItems } from '../../lib/content-utils';
import type { NewsItem } from '../../lib/content-utils';
import { formatDateWithWeekday } from '../../lib/date-utils';
import DomainSection from './DomainSection.astro';

interface Props {
	date: string;
	entries: CollectionEntry<'daily'>[];
}

const { date, entries } = Astro.props;

const hasData = date.length > 0 && entries.length > 0;
const dateDisplay = hasData ? formatDateWithWeekday(date) : '';

// è®¡ç®—æ€»èµ„è®¯æ¡æ•°ï¼ˆä¸å¯å˜ï¼Œé˜²å¾¡éæ•°å­—å€¼ï¼‰
const totalCount = entries.reduce((sum, entry) => {
	const count = typeof entry.data.itemCount === 'number' ? entry.data.itemCount : 0;
	return sum + count;
}, 0);

// æŒ‰é¢†åŸŸ order æ’åºï¼Œæ„å»ºåˆ†ç»„æ•°æ®ï¼ˆä¸å¯å˜ï¼‰
type DomainGroup = { readonly domain: DomainConfig; readonly items: readonly NewsItem[] };
const groups: readonly DomainGroup[] = domains
	.map((domainConfig) => {
		const entry = entries.find((e) => e.data.domain === domainConfig.slug);
		if (!entry) return null;
		try {
			const items = parseNewsItems(entry.body ?? '');
			return items.length > 0 ? { domain: domainConfig, items } : null;
		} catch {
			// æŸåçš„å†…å®¹æ–‡ä»¶ä¸åº”é˜»æ–­æ•´é¡µæ¸²æŸ“
			return null;
		}
	})
	.filter((g): g is DomainGroup => g !== null);
---

<div class="news-list">
	{groups.length > 0 ? (
		<>
			<div class="date-group-header">
				<span class="date-bar"></span>
				<span class="date-text">{dateDisplay}</span>
				<span class="count-badge">{totalCount} æ¡èµ„è®¯</span>
			</div>
			<div class="domain-groups">
				{groups.map((g) => (
					<DomainSection domain={g.domain} items={g.items} date={date} />
				))}
			</div>
		</>
	) : (
		<div class="empty-state">
			<p class="empty-icon">ğŸ“­</p>
			<p class="empty-text">æš‚æ— èµ„è®¯å†…å®¹</p>
			<p class="empty-hint">å½“å¤©çš„èµ„è®¯å°šæœªå‘å¸ƒï¼Œè¯·ç¨åå†æ¥æŸ¥çœ‹</p>
		</div>
	)}
</div>

<style>
	.news-list {
		width: 100%;
	}
	.date-group-header {
		display: flex;
		align-items: center;
		gap: 10px;
		margin-bottom: 20px;
	}
	.date-bar {
		display: inline-block;
		width: 4px;
		height: 20px;
		background: #1677FF;
		border-radius: 2px;
		flex-shrink: 0;
	}
	.date-text {
		font-size: 18px;
		font-weight: 600;
		color: #1A1A1A;
	}
	.count-badge {
		font-size: 12px;
		color: #1677FF;
		background: #E6F4FF;
		padding: 2px 10px;
		border-radius: 10px;
	}
	.domain-groups {
		display: flex;
		flex-direction: column;
		gap: 8px;
	}
	.empty-state {
		text-align: center;
		padding: 60px 20px;
	}
	.empty-icon {
		font-size: 48px;
		margin: 0 0 16px;
	}
	.empty-text {
		font-size: 18px;
		font-weight: 600;
		color: #1A1A1A;
		margin: 0 0 8px;
	}
	.empty-hint {
		font-size: 14px;
		color: #8C8C8C;
		margin: 0;
	}

	@media (max-width: 767px) {
		.date-text {
			font-size: 16px;
		}
		.date-group-header {
			gap: 8px;
			margin-bottom: 16px;
		}
		.count-badge {
			font-size: 11px;
			padding: 2px 8px;
		}
		.empty-state {
			padding: 40px 16px;
		}
		.empty-icon {
			font-size: 40px;
		}
		.empty-text {
			font-size: 16px;
		}
	}
</style>
