name: Daily Pipeline

on:
  schedule:
    # 每日 UTC 01:00（北京时间 09:00）
    - cron: "0 1 * * *"

  workflow_dispatch:
    inputs:
      domain:
        description: "指定领域 slug（留空执行全部领域）"
        required: false
        default: "all"
        type: choice
        # 注意：新增领域时需同步更新此列表，与 src/config/domains.ts 保持一致
        options:
          - all
          - ai-tech
          - cross-border-ecom
          - product-startup
          - github-trending
      date:
        description: "指定执行日期 YYYY-MM-DD（留空使用 UTC 当天）"
        required: false
        type: string
      dry_run:
        description: "模拟执行（不写入文件、不提交）"
        required: false
        default: false
        type: boolean

permissions:
  contents: write

concurrency:
  group: pipeline-${{ github.ref }}
  cancel-in-progress: false

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Configure Git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Validate and build pipeline arguments
        id: args
        env:
          # 安全：通过 env 传递用户输入，避免 ${{ }} 直接注入 shell 导致命令注入
          INPUT_DOMAIN: ${{ github.event.inputs.domain }}
          INPUT_DATE: ${{ github.event.inputs.date }}
          INPUT_DRY_RUN: ${{ github.event.inputs.dry_run }}
        run: |
          ARGS=""
          DOMAIN="${INPUT_DOMAIN:-all}"
          if [ "$DOMAIN" != "all" ] && [ -n "$DOMAIN" ]; then
            # 校验 domain 仅含合法字符（小写字母、数字、连字符）
            if ! echo "$DOMAIN" | grep -qE '^[a-z0-9]+(-[a-z0-9]+)*$'; then
              echo "::error::Invalid domain slug: $DOMAIN"
              exit 1
            fi
            ARGS="$ARGS --domain $DOMAIN"
          fi
          DATE="$INPUT_DATE"
          if [ -n "$DATE" ]; then
            # 校验 date 格式为 YYYY-MM-DD
            if ! echo "$DATE" | grep -qE '^[0-9]{4}-(0[1-9]|1[0-2])-(0[1-9]|[12][0-9]|3[01])$'; then
              echo "::error::Invalid date format: $DATE (expected YYYY-MM-DD)"
              exit 1
            fi
            ARGS="$ARGS --date $DATE"
          fi
          DRY_RUN="$INPUT_DRY_RUN"
          if [ "$DRY_RUN" = "true" ]; then
            ARGS="$ARGS --dry-run"
          fi
          echo "pipeline_args=$ARGS" >> "$GITHUB_OUTPUT"

      - name: Run pipeline
        env:
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          LLM_BASE_URL: ${{ secrets.LLM_BASE_URL }}
          PIPELINE_ARGS: ${{ steps.args.outputs.pipeline_args }}
        run: pnpm run pipeline -- $PIPELINE_ARGS
